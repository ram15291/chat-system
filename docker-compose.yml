name: chat-app

x-common-env: &common_env
  NODE_ENV: production

x-common-depends: &common_depends
  postgres:
    condition: service_healthy
  redis:
    condition: service_healthy

services:
  # =========================
  # INFRA
  # =========================
  postgres:
    profiles: ["infra"]
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: chatdb
      POSTGRES_USER: chatuser
      POSTGRES_PASSWORD: chatpass
    ports:
      - "5432:5432" # keep if you want host access (psql/GUI)
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U chatuser -d chatdb"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    networks: [chat-network]

  redis:
    profiles: ["infra"]
    image: redis:7-alpine
    command: redis-server --appendonly yes
    ports:
      - "6379:6379" # optional; keep if you want host access
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    networks: [chat-network]

  localstack:
    profiles: ["infra"]
    image: localstack/localstack:latest
    environment:
      SERVICES: dynamodb
      DEBUG: 0
      EDGE_PORT: 4566
      AWS_DEFAULT_REGION: us-east-1
    ports:
      - "4566:4566" # LocalStack gateway
    volumes:
      - localstack_data:/var/lib/localstack
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 20
    restart: unless-stopped
    networks: [chat-network]

  # ---- DynamoDB init (tables) ----
  dynamodb-init:
    profiles: ["infra"]
    image: amazon/aws-cli:2.15.56
    depends_on:
      localstack:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: us-east-1
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e
        echo "Creating DynamoDB tables (if not exists)..."

        # Messages table with conversation_id and seq as keys
        aws --endpoint-url=http://localstack:4566 dynamodb create-table \
          --table-name messages \
          --attribute-definitions \
            AttributeName=conversation_id,AttributeType=S \
            AttributeName=seq,AttributeType=N \
            AttributeName=message_id,AttributeType=S \
          --key-schema \
            AttributeName=conversation_id,KeyType=HASH \
            AttributeName=seq,KeyType=RANGE \
          --global-secondary-indexes \
            "IndexName=MessageIdIndex,KeySchema=[{AttributeName=message_id,KeyType=HASH}],Projection={ProjectionType=ALL}" \
          --billing-mode PAY_PER_REQUEST \
        || true

        # Optional GSI example (uncomment if you need)
        # aws --endpoint-url=http://localstack:4566 dynamodb update-table \
        #   --table-name messages \
        #   --attribute-definitions \
        #     AttributeName=chat_id,AttributeType=S \
        #     AttributeName=created_at,AttributeType=N \
        #   --global-secondary-index-updates \
        #     '[{"Create":{"IndexName":"gsi_chat_time","KeySchema":[{"AttributeName":"chat_id","KeyType":"HASH"},{"AttributeName":"created_at","KeyType":"RANGE"}],"Projection":{"ProjectionType":"ALL"}}}]' \
        # || true

        echo "DynamoDB init done."
    networks: [chat-network]

  zookeeper:
    profiles: ["infra"]
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    restart: unless-stopped
    networks: [chat-network]

  kafka:
    profiles: ["infra"]
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zookeeper
    ports:
      - "9092:9092" # host access (optional but handy)
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181

      # Internal listener for other containers
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9093,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9093,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9093"]
      interval: 10s
      timeout: 10s
      retries: 20
    restart: unless-stopped
    networks: [chat-network]

  kafka-init:
    profiles: ["infra", "apps"]
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e
        echo "Waiting for Kafka to be ready..."
        cub kafka-ready -b kafka:9093 1 30

        echo "Creating Kafka topics..."
        kafka-topics --create --if-not-exists --topic message.new --bootstrap-server kafka:9093 --partitions 3 --replication-factor 1
        kafka-topics --create --if-not-exists --topic message.fanout --bootstrap-server kafka:9093 --partitions 3 --replication-factor 1
        echo "Kafka topics created."
    networks: [chat-network]

  # =========================
  # OBSERVABILITY (Loki stack)
  # =========================
  loki:
    profiles: ["obs"]
    image: grafana/loki:2.9.8
    command: -config.file=/etc/loki/config.yml
    ports:
      - "3100:3100"
    volumes:
      - ./observability/loki-config.yml:/etc/loki/config.yml:ro
      - loki_data:/loki
    restart: unless-stopped
    networks: [chat-network]

  promtail:
    profiles: ["obs"]
    image: grafana/promtail:2.9.8
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./observability/promtail-config.yml:/etc/promtail/config.yml:ro
    depends_on:
      - loki
    restart: unless-stopped
    networks: [chat-network]

  grafana:
    profiles: ["obs"]
    image: grafana/grafana:10.4.5
    ports:
      - "3005:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./observability/grafana-provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - loki
    restart: unless-stopped
    networks: [chat-network]

  # =========================
  # APPS (scalable)
  # =========================
  user-service:
    profiles: ["apps", "ui"]
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    environment:
      <<: *common_env
      PORT: 3001
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: chatuser
      POSTGRES_PASSWORD: chatpass
      POSTGRES_DB: chatdb
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      JWT_EXPIRES_IN: 15m
      REFRESH_TOKEN_EXPIRES_IN: 7d
      REDIS_URL: redis://redis:6379
    # depends_on: *common_depends
    expose:
      - "3001"
    restart: unless-stopped
    networks: [chat-network]

  chat-service:
    profiles: ["apps", "ui"]
    build:
      context: ./services/chat-service
      dockerfile: Dockerfile
    environment:
      <<: *common_env
      PORT: 3002
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: chatuser
      POSTGRES_PASSWORD: chatpass
      POSTGRES_DB: chatdb
      REDIS_URL: redis://redis:6379
      MEMBERSHIP_CACHE_TTL: 60
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
    # depends_on: *common_depends
    expose:
      - "3002"
    restart: unless-stopped
    networks: [chat-network]

  message-service:
    profiles: ["apps", "ui"]
    build:
      context: ./services/message-service
      dockerfile: Dockerfile
    environment:
      <<: *common_env
      PORT: 3003
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: chatuser
      POSTGRES_PASSWORD: chatpass
      POSTGRES_DB: chatdb
      REDIS_URL: redis://redis:6379

      # JWT
      JWT_SECRET: your-super-secret-jwt-key-change-in-production

      # LocalStack DynamoDB
      DYNAMODB_ENDPOINT: http://localstack:4566
      DYNAMODB_REGION: us-east-1

      # ✅ Kafka inside network
      KAFKA_BROKERS: kafka:9093
      KAFKA_CLIENT_ID: message-service

      CHAT_SERVICE_URL: http://chat-service:3002/api/chats

      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: us-east-1
    # depends_on:
    #   postgres:
    #     condition: service_healthy
    #   redis:
    #     condition: service_healthy
    #   localstack:
    #     condition: service_healthy
    #   kafka:
    #     condition: service_healthy
    #   dynamodb-init:
    #     condition: service_started
    #   kafka-init:
    #     condition: service_started
    expose:
      - "3003"
    restart: unless-stopped
    networks: [chat-network]

  gateway:
    profiles: ["apps", "ui"]
    build:
      context: ./services/realtime-gateway
      dockerfile: Dockerfile
    environment:
      <<: *common_env
      PORT: 3004
      REDIS_URL: redis://redis:6379
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      HEARTBEAT_INTERVAL: 30000
    # depends_on:
    #   redis:
    #     condition: service_healthy
    expose:
      - "3004"
    restart: unless-stopped
    networks: [chat-network]

  fanout-worker:
    profiles: ["apps"]
    build:
      context: ./services/fanout-worker
      dockerfile: Dockerfile
    environment:
      <<: *common_env
      # ✅ Kafka inside network
      KAFKA_BROKERS: kafka:9093
      KAFKA_GROUP_ID: fanout-workers
      KAFKA_CLIENT_ID: fanout-worker
      REDIS_URL: redis://redis:6379
      CHAT_SERVICE_URL: http://chat-service:3002/api/chats
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: us-east-1
    # depends_on:
    #   redis:
    #     condition: service_healthy
    #   kafka:
    #     condition: service_healthy
    #   kafka-init:
    #     condition: service_started
    restart: unless-stopped
    networks: [chat-network]

  # =========================
  # EDGE (nginx LB)
  # =========================
  nginx:
    profiles: ["edge", "ui"]
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - user-service
      - chat-service
      - message-service
      - gateway
    restart: unless-stopped
    networks: [chat-network]

  # =========================
  # UI
  # =========================
  frontend:
    profiles: ["ui"]
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        REACT_APP_API_URL: http://localhost
        REACT_APP_WS_URL: ws://localhost
    ports:
      - "3000:80"
    depends_on:
      - nginx
    restart: unless-stopped
    networks: [chat-network]

volumes:
  postgres_data:
  redis_data:
  localstack_data:
  grafana_data:
  loki_data:

networks:
  chat-network:
    driver: bridge
